<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Speed Test Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-controls {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status {
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.error {
            background-color: #ffebee;
            color: #c62828;
        }
        .status.success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .status.warning {
            background-color: #fff8e1;
            color: #ff8f00;
        }
        .progress-bar-container {
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .result-item {
            margin: 10px 0;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .debug-panel {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .debug-entry {
            margin: 5px 0;
            padding: 2px 0;
            border-bottom: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket Speed Test</h1>
        
        <div class="test-controls">
            <button id="connectButton">Connect</button>
            <button id="pingButton" disabled>Test Ping</button>
            <button id="downloadButton" disabled>Test Download Speed</button>
            <button id="uploadButton" disabled>Test Upload Speed</button>
            <button id="fullTestButton" disabled>Run Full Test</button>
        </div>
        
        <div class="status" id="status">Ready to connect</div>
        
        <div class="progress-bar-container" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="results" id="results">
            <div class="result-item">
                <strong>Ping:</strong> <span id="pingResult">Not tested</span>
            </div>
            <div class="result-item">
                <strong>Download Speed:</strong> <span id="downloadResult">Not tested</span>
            </div>
            <div class="result-item">
                <strong>Upload Speed:</strong> <span id="uploadResult">Not tested</span>
            </div>
        </div>
        
        <div class="debug-panel" id="debugPanel"></div>
    </div>

    <script>
        // Debug mode
        const DEBUG = true;
        
        // WebSocket connection
        let ws = null;
        let isConnected = false;
        let testInProgress = false;
        let currentRequestId = null;
        
        // Test timers and data
        let pingStartTime = 0;
        let downloadStartTime = 0;
        let uploadStartTime = 0;
        let receivedBytes = 0;
        let totalBytes = 0;
        
        // Configuration
        const hostname = window.location.hostname || 'localhost';
        // Direct connection to WebSocket server on port 8090
        const serverUrl = 'ws://' + hostname + ':8090';
        console.log('WebSocket server URL:', serverUrl);
        const authToken = ''; // Set this if authentication is enabled
        
        // DOM elements
        const connectButton = document.getElementById('connectButton');
        const pingButton = document.getElementById('pingButton');
        const downloadButton = document.getElementById('downloadButton');
        const uploadButton = document.getElementById('uploadButton');
        const fullTestButton = document.getElementById('fullTestButton');
        const statusElement = document.getElementById('status');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const pingResultElement = document.getElementById('pingResult');
        const downloadResultElement = document.getElementById('downloadResult');
        const uploadResultElement = document.getElementById('uploadResult');
        const debugPanel = document.getElementById('debugPanel');
        
        // Debug logging
        function debug(...args) {
            if (!DEBUG) return;
            
            console.log(...args);
            
            const entry = document.createElement('div');
            entry.className = 'debug-entry';
            entry.textContent = new Date().toISOString().substring(11, 23) + ': ' + args.join(' ');
            debugPanel.appendChild(entry);
            debugPanel.scrollTop = debugPanel.scrollHeight;
            
            // Show debug panel
            debugPanel.style.display = 'block';
        }
        
        // Helper functions
        function updateStatus(message, type = 'status') {
            debug('Status:', message);
            statusElement.textContent = message;
            statusElement.className = 'status ' + type;
        }
        
        function setProgress(percent) {
            debug('Progress:', percent + '%');
            if (percent === 0) {
                progressContainer.style.display = 'none';
            } else {
                progressContainer.style.display = 'block';
                progressBar.style.width = `${percent}%`;
            }
        }
        
        function enableButtons(enabled) {
            debug('Buttons enabled:', enabled);
            pingButton.disabled = !enabled || !isConnected;
            downloadButton.disabled = !enabled || !isConnected;
            uploadButton.disabled = !enabled || !isConnected;
            fullTestButton.disabled = !enabled || !isConnected;
            connectButton.disabled = isConnected;
        }
        
        function generateRequestId() {
            return Math.random().toString(36).substring(2, 15);
        }
        
        function formatSpeed(bitsPerSecond) {
            const units = ['bps', 'Kbps', 'Mbps', 'Gbps'];
            let speed = bitsPerSecond;
            let unitIndex = 0;
            
            while (speed >= 1024 && unitIndex < units.length - 1) {
                speed /= 1024;
                unitIndex++;
            }
            
            return `${speed.toFixed(2)} ${units[unitIndex]}`;
        }
        
        // WebSocket functions
        function connectWebSocket() {
            if (isConnected) {
                debug('Already connected');
                return;
            }
            
            try {
                debug('Connecting to', serverUrl);
                updateStatus('Connecting to WebSocket server...', 'warning');
                setProgress(25);
                
                // Create WebSocket connection
                ws = new WebSocket(serverUrl);
                debug('WebSocket object created with readyState:', ws.readyState);
                
                // Connection opened
                ws.addEventListener('open', function(event) {
                    debug('Connection opened, readyState:', ws.readyState);
                    isConnected = true;
                    updateStatus('Connected to WebSocket server', 'success');
                    setProgress(0);
                    enableButtons(true);
                });
                
                // Listen for messages
                ws.addEventListener('message', function(event) {
                    debug('Message received, readyState:', ws.readyState);
                    handleMessage(event);
                });
                
                // Connection closed
                ws.addEventListener('close', function(event) {
                    debug('Connection closed, readyState:', ws.readyState, 'code:', event.code, 'reason:', event.reason);
                    isConnected = false;
                    updateStatus('Connection closed: ' + (event.reason || 'Unknown reason'), 'error');
                    enableButtons(false);
                });
                
                // Connection error
                ws.addEventListener('error', function(event) {
                    debug('Connection error, readyState:', ws.readyState);
                    updateStatus('Connection error', 'error');
                    isConnected = false;
                    enableButtons(false);
                });
            } catch (error) {
                debug('Connection error:', error);
                updateStatus('Failed to connect: ' + error.message, 'error');
            }
        }
        
        function sendMessage(message) {
            if (!isConnected || !ws) {
                debug('Cannot send message: Not connected');
                return false;
            }
            
            try {
                const jsonString = JSON.stringify(message);
                debug('Sending message:', jsonString);
                debug('WebSocket readyState:', ws.readyState);
                
                // Check WebSocket state
                if (ws.readyState !== WebSocket.OPEN) {
                    debug('WebSocket is not in OPEN state:', ws.readyState);
                    return false;
                }
                
                ws.send(jsonString);
                console.log('Message sent successfully:', jsonString);
                return true;
            } catch (error) {
                debug('Error sending message:', error);
                console.error('Failed to send message:', error);
                return false;
            }
        }
        
        // Message handler
        function handleMessage(event) {
            // Check if it's a binary message (for download test)
            if (event.data instanceof ArrayBuffer || event.data instanceof Blob) {
                handleBinaryMessage(event.data);
                return;
            }
            
            // Parse JSON message
            try {
                const message = JSON.parse(event.data);
                debug('Received message:', JSON.stringify(message));
                
                const messageType = message.type;
                const requestId = message.requestId;
                
                debug('Message type:', messageType, 'Request ID:', requestId, 'Current Request ID:', currentRequestId);
                
                // Check if this message is for our current request
                if (currentRequestId && requestId && currentRequestId !== requestId) {
                    debug('Ignoring message for different request');
                    return;
                }
                
                // Handle different message types
                switch (messageType) {
                    case 'connected':
                        debug('Handling connected message');
                        handleConnected(message);
                        break;
                    case 'pong':
                        debug('Handling pong message');
                        handlePong(message);
                        break;
                    case 'download_start':
                        debug('Handling download_start message');
                        handleDownloadStart(message);
                        break;
                    case 'download_progress':
                        debug('Handling download_progress message');
                        handleDownloadProgress(message);
                        break;
                    case 'download_complete':
                        debug('Handling download_complete message');
                        handleDownloadComplete(message);
                        break;
                    case 'upload_ready':
                        debug('Handling upload_ready message');
                        handleUploadReady(message);
                        break;
                    case 'upload_progress':
                        debug('Handling upload_progress message');
                        handleUploadProgress(message);
                        break;
                    case 'upload_result':
                        debug('Handling upload_result message');
                        handleUploadResult(message);
                        break;
                    case 'upload_complete_ack':
                        debug('Handling upload_complete_ack message');
                        handleUploadCompleteAck(message);
                        break;
                    case 'error':
                        debug('Handling error message');
                        handleError(message);
                        break;
                    default:
                        debug('Unknown message type:', messageType);
                }
            } catch (error) {
                debug('Error parsing message:', error);
            }
        }
        
        // Binary message handler
        async function handleBinaryMessage(data) {
            // Convert Blob to ArrayBuffer if needed
            let arrayBuffer = data;
            if (data instanceof Blob) {
                arrayBuffer = await data.arrayBuffer();
            }
            
            // Update received bytes for download test
            receivedBytes += arrayBuffer.byteLength;
            
            // Calculate progress if total bytes is known
            if (totalBytes > 0) {
                const progress = Math.min((receivedBytes / totalBytes) * 100, 100);
                setProgress(progress);
            }
        }
        
        // Message type handlers
        function handleConnected(message) {
            debug('Connected to server:', message.message);
            updateStatus('Connected: ' + message.message, 'success');
        }
        
        function handlePong(message) {
            const pingTime = Date.now() - pingStartTime;
            debug('Ping time:', pingTime, 'ms');
            pingResultElement.textContent = `${pingTime.toFixed(2)} ms`;
            updateStatus('Ping test completed', 'success');
            setProgress(100);
            
            setTimeout(() => {
                if (!testInProgress) {
                    setProgress(0);
                }
            }, 1000);
            
            testInProgress = false;
            enableButtons(true);
        }
        
        function handleDownloadStart(message) {
            downloadStartTime = Date.now();
            totalBytes = message.totalSize || 0;
            receivedBytes = 0;
            debug('Download test started, total size:', totalBytes, 'bytes');
        }
        
        function handleDownloadProgress(message) {
            if (message.progress) {
                setProgress(Math.min(message.progress, 100));
            }
        }
        
        function handleDownloadComplete(message) {
            const downloadTime = (Date.now() - downloadStartTime) / 1000; // seconds
            const totalBytes = message.totalBytes || receivedBytes;
            const bytesPerSecond = totalBytes / downloadTime;
            const bitsPerSecond = bytesPerSecond * 8;
            
            debug('Download completed:', totalBytes, 'bytes in', downloadTime, 'seconds');
            debug('Download speed:', formatSpeed(bitsPerSecond));
            
            downloadResultElement.textContent = formatSpeed(bitsPerSecond);
            updateStatus('Download test completed', 'success');
            setProgress(100);
            
            setTimeout(() => {
                if (!testInProgress) {
                    setProgress(0);
                }
            }, 1000);
            
            testInProgress = false;
            enableButtons(true);
        }
        
        function handleUploadReady(message) {
            debug('Upload test ready');
            uploadStartTime = Date.now();
            sendUploadData();
        }
        
        function handleUploadProgress(message) {
            if (message.progress) {
                setProgress(Math.min(message.progress, 100));
            }
        }
        
        function handleUploadResult(message) {
            debug('Upload result received:', message);
            
            if (message.bitsPerSecond) {
                uploadResultElement.textContent = formatSpeed(message.bitsPerSecond);
                updateStatus('Upload test completed', 'success');
                setProgress(100);
                
                setTimeout(() => {
                    if (!testInProgress) {
                        setProgress(0);
                    }
                }, 1000);
            }
            
            testInProgress = false;
            enableButtons(true);
        }
        
        function handleError(message) {
            const errorMessage = message.message || 'Unknown error';
            debug('Error from server:', errorMessage);
            updateStatus('Error: ' + errorMessage, 'error');
            testInProgress = false;
            enableButtons(true);
        }
        
        function handleUploadCompleteAck(message) {
            debug('Upload completion acknowledged by server');
            // This is just an acknowledgment from the server that it received the upload_complete message
            // No additional action needed, but we handle it to avoid "unknown message type" errors
        }
        
        // Send upload data
        function sendUploadData() {
            const chunkSize = 65536; // 64KB (safe for crypto.getRandomValues)
            const totalSize = 1024 * 1024; // 1MB total
            const chunks = Math.ceil(totalSize / chunkSize);
            
            debug('Starting upload test:', chunks, 'chunks of', chunkSize, 'bytes');
            
            for (let i = 0; i < chunks; i++) {
                setTimeout(() => {
                    if (!isConnected) return;
                    
                    // Create random data
                    const size = (i === chunks - 1) ? (totalSize - (i * chunkSize)) : chunkSize;
                    const data = new ArrayBuffer(size);
                    const view = new Uint8Array(data);
                    
                    // Fill with random data in chunks of 65536 bytes (crypto.getRandomValues limit)
                    const maxChunkSize = 65536;
                    for (let offset = 0; offset < size; offset += maxChunkSize) {
                        const length = Math.min(maxChunkSize, size - offset);
                        const chunk = new Uint8Array(length);
                        crypto.getRandomValues(chunk);
                        view.set(chunk, offset);
                    }
                    
                    // Send the chunk
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(data);
                    }
                    
                    // Update progress
                    const progress = Math.min(((i + 1) / chunks) * 100, 100);
                    setProgress(progress);
                    
                    // If last chunk, send completion message
                    if (i === chunks - 1) {
                        setTimeout(() => {
                            sendMessage({
                                type: 'upload_complete',
                                requestId: currentRequestId
                            });
                        }, 100);
                    }
                }, i * 50); // Send chunks with small delay between them
            }
        }
        
        // Test functions
        function testPing() {
            if (testInProgress || !isConnected) return;
            
            testInProgress = true;
            enableButtons(false);
            updateStatus('Testing ping...', 'status');
            setProgress(50);
            
            pingStartTime = Date.now();
            currentRequestId = generateRequestId();
            
            if (!sendMessage({
                type: 'ping',
                requestId: currentRequestId
            })) {
                updateStatus('Failed to send ping request', 'error');
                testInProgress = false;
                enableButtons(true);
            }
        }
        
        function testDownloadSpeed() {
            if (testInProgress || !isConnected) return;
            
            testInProgress = true;
            enableButtons(false);
            updateStatus('Testing download speed...', 'status');
            setProgress(0);
            
            receivedBytes = 0;
            totalBytes = 0;
            currentRequestId = generateRequestId();
            
            if (!sendMessage({
                type: 'download',
                size: 1024 * 1024, // 1MB
                requestId: currentRequestId
            })) {
                updateStatus('Failed to send download request', 'error');
                testInProgress = false;
                enableButtons(true);
            }
        }
        
        function testUploadSpeed() {
            if (testInProgress || !isConnected) return;
            
            testInProgress = true;
            enableButtons(false);
            updateStatus('Testing upload speed...', 'status');
            setProgress(0);
            
            currentRequestId = generateRequestId();
            
            if (!sendMessage({
                type: 'upload',
                size: 1024 * 1024, // 1MB
                requestId: currentRequestId
            })) {
                updateStatus('Failed to send upload request', 'error');
                testInProgress = false;
                enableButtons(true);
            }
        }
        
        async function runFullTest() {
            if (testInProgress || !isConnected) return;
            
            // Run tests in sequence
            updateStatus('Running full speed test...', 'status');
            
            // Test ping
            testInProgress = true;
            enableButtons(false);
            updateStatus('Testing ping...', 'status');
            setProgress(25);
            
            pingStartTime = Date.now();
            currentRequestId = generateRequestId();
            
            if (!sendMessage({
                type: 'ping',
                requestId: currentRequestId
            })) {
                updateStatus('Failed to send ping request', 'error');
                testInProgress = false;
                enableButtons(true);
                return;
            }
            
            // Wait for ping test to complete
            await new Promise(resolve => {
                const checkInterval = setInterval(() => {
                    if (!testInProgress) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
            });
            
            // Test download
            testInProgress = true;
            updateStatus('Testing download speed...', 'status');
            setProgress(50);
            
            receivedBytes = 0;
            totalBytes = 0;
            currentRequestId = generateRequestId();
            
            if (!sendMessage({
                type: 'download',
                size: 1024 * 1024, // 1MB
                requestId: currentRequestId
            })) {
                updateStatus('Failed to send download request', 'error');
                testInProgress = false;
                enableButtons(true);
                return;
            }
            
            // Wait for download test to complete
            await new Promise(resolve => {
                const checkInterval = setInterval(() => {
                    if (!testInProgress) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
            });
            
            // Test upload
            testInProgress = true;
            updateStatus('Testing upload speed...', 'status');
            setProgress(75);
            
            currentRequestId = generateRequestId();
            
            if (!sendMessage({
                type: 'upload',
                size: 1024 * 1024, // 1MB
                requestId: currentRequestId
            })) {
                updateStatus('Failed to send upload request', 'error');
                testInProgress = false;
                enableButtons(true);
                return;
            }
            
            // Wait for upload test to complete
            await new Promise(resolve => {
                const checkInterval = setInterval(() => {
                    if (!testInProgress) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
            });
            
            // All tests completed
            updateStatus('Speed test completed', 'success');
            setProgress(100);
            
            setTimeout(() => {
                setProgress(0);
            }, 1000);
        }
        
        // Event listeners
        connectButton.addEventListener('click', connectWebSocket);
        pingButton.addEventListener('click', testPing);
        downloadButton.addEventListener('click', testDownloadSpeed);
        uploadButton.addEventListener('click', testUploadSpeed);
        fullTestButton.addEventListener('click', runFullTest);
    </script>
</body>
</html>
